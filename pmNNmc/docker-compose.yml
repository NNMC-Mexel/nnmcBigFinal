# NNMC IT Project Board - Docker Compose
# For Coolify deployment or local development

version: '3.8'

services:
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: nnmc-backend
    restart: unless-stopped
    ports:
      - "12005:12005"
    environment:
      # Server
      HOST: 0.0.0.0
      PORT: 12005
      NODE_ENV: production
      
      # Secrets (CHANGE THESE IN PRODUCTION!)
      APP_KEYS: ${APP_KEYS:-change-me-key1,change-me-key2,change-me-key3,change-me-key4}
      API_TOKEN_SALT: ${API_TOKEN_SALT:-change-me-api-token-salt}
      ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET:-change-me-admin-jwt-secret}
      TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT:-change-me-transfer-token-salt}
      JWT_SECRET: ${JWT_SECRET:-change-me-jwt-secret}
      
      # Database
      DATABASE_CLIENT: sqlite
      DATABASE_FILENAME: .tmp/data.db
      
      # SMTP (Email)
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@nnmc.kz}
      SMTP_REPLY_TO: ${SMTP_REPLY_TO:-support@nnmc.kz}
      
      # CORS
      FRONTEND_URL: ${FRONTEND_URL:-http://192.168.101.25:13005}
    volumes:
      # Persist SQLite database and uploads
      - backend_data:/app/.tmp
      - backend_uploads:/app/public/uploads
    networks:
      - nnmc-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:12005/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://192.168.101.25:12005}
        VITE_FRONTEND_URL: ${VITE_FRONTEND_URL:-http://192.168.101.25:13005}
    container_name: nnmc-frontend
    restart: unless-stopped
    ports:
      - "13005:13005"
    depends_on:
      - backend
    networks:
      - nnmc-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:13005"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  backend_data:
    driver: local
  backend_uploads:
    driver: local

networks:
  nnmc-network:
    driver: bridge
